/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/validation.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Injector, Optional, Renderer2, Self, SkipSelf, TemplateRef, ViewContainerRef, } from '@angular/core';
import { NgControl } from '@angular/forms';
import { merge, Subscription } from 'rxjs';
import { filter, map, mapTo, tap } from 'rxjs/operators';
import { AbstractValidationDirective } from '../abstracts';
import { generateValidationError } from '../utils';
import { ValidationContainerDirective } from './validation-container.directive';
import { ValidationGroupDirective } from './validation-group.directive';
import { ValidationStyleDirective } from './validation-style.directive';
import { ValidationTargetDirective } from './validation-target.directive';
export class ValidationDirective extends AbstractValidationDirective {
    /**
     * @param {?} injector
     * @param {?} cdRef
     * @param {?} cfRes
     * @param {?} control
     * @param {?} renderer
     * @param {?} vcRef
     * @param {?} parentRef
     * @param {?} markRef
     * @param {?} targetRef
     * @param {?} containerRef
     */
    constructor(injector, cdRef, cfRes, control, renderer, vcRef, parentRef, markRef, targetRef, containerRef) {
        super(injector);
        this.injector = injector;
        this.cdRef = cdRef;
        this.cfRes = cfRes;
        this.control = control;
        this.renderer = renderer;
        this.vcRef = vcRef;
        this.parentRef = parentRef;
        this.markRef = markRef;
        this.targetRef = targetRef;
        this.containerRef = containerRef;
        this.isSubmitted = false;
        this.subscriptions = new Subscription();
    }
    /**
     * @return {?}
     */
    get validation$() {
        return merge(this.parent.getStream('status').pipe(mapTo(null)), this.parent.getStream('value').pipe(mapTo(null)), this.parent.getStream('submit'));
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    buildErrors(errors) {
        return Object.keys(errors || {}).map((/**
         * @param {?} key
         * @return {?}
         */
        key => generateValidationError(key, errors[key], this.blueprints[key])));
    }
    /**
     * @private
     * @return {?}
     */
    insertErrorClasses() {
        this.renderer.addClass(this.markElement, this.invalidClasses);
    }
    /**
     * @private
     * @this {?}
     * @param {?} errors
     * @return {?}
     */
    insertErrors(errors) {
        /** @type {?} */
        const template = this.errorTemplate;
        /** @type {?} */
        const targetRef = this.containerRef ? this.containerRef.targetRef : this.targetRef;
        /** @type {?} */
        const vcRef = targetRef ? targetRef.vcRef : this.vcRef;
        this.errorRef =
            template instanceof TemplateRef
                ? vcRef.createEmbeddedView(template, { $implicit: errors }, vcRef.length)
                : vcRef.createComponent(this.cfRes.resolveComponentFactory(template), vcRef.length, this.injector);
        if (this.errorRef instanceof ComponentRef && this.errorRef.instance)
            ((/** @type {?} */ (this.errorRef))).instance.validationErrors = errors;
    }
    /**
     * @private
     * @return {?}
     */
    removeErrorClasses() {
        this.renderer.removeClass(this.markElement, this.invalidClasses);
    }
    /**
     * @private
     * @return {?}
     */
    removeErrors() {
        if (this.errorRef) {
            this.errorRef.destroy();
            this.errorRef = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    setMarkElement() {
        this.markElement =
            (this.markRef
                ? this.markRef.elRef.nativeElement
                : this.targetSelector
                    ? this.elRef.nativeElement.closest(this.targetSelector)
                    : null) || this.elRef.nativeElement;
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    shouldValidate(errors) {
        return errors.length && this.control.dirty && (!this.validateOnSubmit || this.isSubmitted);
    }
    /**
     * @private
     * @return {?}
     */
    subscribeToValidation() {
        /** @type {?} */
        let cached;
        this.subscriptions.add(this.validation$
            .pipe(filter((/**
         * @return {?}
         */
        () => !this.skipValidation)), tap((/**
         * @param {?} form
         * @return {?}
         */
        form => {
            if (form) {
                this.control.control.markAsDirty();
                this.isSubmitted = true;
            }
        })), map((/**
         * @return {?}
         */
        () => this.mapErrorsFn(this.buildErrors(this.control.errors), this.buildErrors((this.parentRef.group || ((/** @type {?} */ ({})))).errors), this.control))))
            .subscribe((/**
         * @param {?} errors
         * @return {?}
         */
        errors => {
            if (cached === JSON.stringify(errors))
                return;
            this.removeErrors();
            if (this.shouldValidate(errors)) {
                this.insertErrors(errors);
                if (!cached)
                    this.insertErrorClasses();
                cached = JSON.stringify(errors);
            }
            else {
                this.removeErrorClasses();
                cached = '';
            }
            this.cdRef.markForCheck();
        })));
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.setMarkElement();
        this.subscribeToValidation();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
}
ValidationDirective.decorators = [
    { type: Directive, args: [{
                /* tslint:disable-next-line */
                selector: '[formControl],[formControlName]',
                exportAs: 'validationDirective',
            },] }
];
/** @nocollapse */
ValidationDirective.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: ComponentFactoryResolver },
    { type: NgControl, decorators: [{ type: Self }] },
    { type: Renderer2 },
    { type: ViewContainerRef },
    { type: ValidationGroupDirective, decorators: [{ type: SkipSelf }] },
    { type: ValidationStyleDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: ValidationTargetDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: ValidationContainerDirective, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.errorRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markElement;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.isSubmitted;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.subscriptions;
    /** @type {?} */
    ValidationDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cfRes;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.control;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.vcRef;
    /** @type {?} */
    ValidationDirective.prototype.parentRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markRef;
    /** @type {?} */
    ValidationDirective.prototype.targetRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.containerRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXZhbGlkYXRlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy92YWxpZGF0aW9uLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsd0JBQXdCLEVBQ3hCLFlBQVksRUFDWixTQUFTLEVBRVQsUUFBUSxFQUVSLFFBQVEsRUFDUixTQUFTLEVBQ1QsSUFBSSxFQUNKLFFBQVEsRUFDUixXQUFXLEVBQ1gsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYSxTQUFTLEVBQW9CLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBYyxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUczRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFPMUUsTUFBTSxPQUFPLG1CQUFvQixTQUFRLDJCQUEyQjs7Ozs7Ozs7Ozs7OztJQWdCbEUsWUFDUyxRQUFrQixFQUNqQixLQUF3QixFQUN4QixLQUErQixFQUN2QixPQUFrQixFQUMxQixRQUFtQixFQUNuQixLQUF1QixFQUNaLFNBQW1DLEVBQ3RCLE9BQWlDLEVB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QkFBcUI7YUFDaEM7Ozs7WUF6QkMsUUFBUTtZQUxSLGlCQUFpQjtZQUNqQix3QkFBd0I7WUFhTixTQUFTLHVCQXFDeEIsSUFBSTtZQTNDUCxTQUFTO1lBSVQsZ0JBQWdCO1lBVVQsd0JBQXdCLHVCQWdDNUIsUUFBUTtZQS9CSix3QkFBd0IsdUJBZ0M1QixRQUFRLFlBQUksUUFBUTtZQS9CaEIseUJBQXlCLHVCQWdDN0IsUUFBUSxZQUFJLFFBQVE7WUFuQ2hCLDRCQUE0Qix1QkFvQ2hDLFFBQVE7Ozs7Ozs7SUF4QlgsdUNBQWdGOzs7OztJQUNoRiwwQ0FBaUM7Ozs7O0lBQ2pDLDBDQUE0Qjs7Ozs7SUFVNUIsNENBQTJDOztJQUd6Qyx1Q0FBeUI7Ozs7O0lBQ3pCLG9DQUFnQzs7Ozs7SUFDaEMsb0NBQXVDOzs7OztJQUN2QyxzQ0FBa0M7Ozs7O0lBQ2xDLHVDQUEyQjs7Ozs7SUFDM0Isb0NBQStCOztJQUMvQix3Q0FBc0Q7Ozs7O0lBQ3RELHNDQUFpRTs7SUFDakUsd0NBQW1FOzs7OztJQUNuRSwyQ0FBOEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBJbmplY3RvcixcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXIyLFxuICBTZWxmLFxuICBTa2lwU2VsZixcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBOZ0NvbnRyb2wsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBtZXJnZSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgbWFwVG8sIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFic3RyYWN0VmFsaWRhdGlvbkRpcmVjdGl2ZSB9IGZyb20gJy4uL2Fic3RyYWN0cyc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3JDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzJztcbmltcG9ydCB7IFZhbGlkYXRpb24gfSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uQ29udGFpbmVyRGlyZWN0aXZlIH0gZnJvbSAnLi92YWxpZGF0aW9uLWNvbnRhaW5lci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkdyb3VwRGlyZWN0aXZlIH0gZnJvbSAnLi92YWxpZGF0aW9uLWdyb3VwLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uU3R5bGVEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tc3R5bGUuZGlyZWN0aXZlJztcbmltcG9ydCB7IFZhbGlkYXRpb25UYXJnZXREaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tdGFyZ2V0LmRpcmVjdGl2ZSc7XG5cbkBEaXJlY3RpdmUoe1xuICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmUgKi9cbiAgc2VsZWN0b3I6ICdbZm9ybUNvbnRyb2xdLFtmb3JtQ29udHJvbE5hbWVdJyxcbiAgZXhwb3J0QXM6ICd2YWxpZGF0aW9uRGlyZWN0aXZlJyxcbn0pXG5leHBvcnQgY2xhc3MgVmFsaWRhdGlvbkRpcmVjdGl2ZSBleHRlbmRzIEFic3RyYWN0VmFsaWRhdGlvbkRpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgZXJyb3JSZWY6IENvbXBvbmVudFJlZjxWYWxpZGF0aW9uRXJyb3JDb21wb25lbnQ+IHwgRW1iZWRkZWRWaWV3UmVmPGFueT47XG4gIHByaXZhdGUgbWFya0VsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGlzU3VibWl0dGVkID0gZmFsc2U7XG5cbiAgZ2V0IHZhbGlkYXRpb24kKCk6IE9ic2VydmFibGU8Rm9ybUdyb3VwPiB7XG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCdzdGF0dXMnKS5waXBlKG1hcFRvKG51bGwpKSxcbiAgICAgIHRoaXMucGFyZW50LmdldFN0cmVhbSgndmFsdWUnKS5waXBlKG1hcFRvKG51bGwpKSxcbiAgICAgIHRoaXMucGFyZW50LmdldFN0cmVhbSgnc3VibWl0JyksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9ucyA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgY2ZSZXM6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBAU2VsZigpIHByaXZhdGUgY29udHJvbDogTmdDb250cm9sLFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIHZjUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIEBTa2lwU2VsZigpIHB1YmxpYyBwYXJlbnRSZWY6IFZhbGlkYXRpb25Hcm91cERpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBAU2tpcFNlbGYoKSBwcml2YXRlIG1hcmtSZWY6IFZhbGlkYXRpb25TdHlsZURpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBAU2tpcFNlbGYoKSBwdWJsaWMgdGFyZ2V0UmVmOiBWYWxpZGF0aW9uVGFyZ2V0RGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgY29udGFpbmVyUmVmOiBWYWxpZGF0aW9uQ29udGFpbmVyRGlyZWN0aXZlLFxuICApIHtcbiAgICBzdXBlcihpbmplY3Rvcik7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRXJyb3JzKGVycm9yczogVmFsaWRhdGlvbkVycm9ycyk6IFZhbGlkYXRpb24uRXJyb3JbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGVycm9ycyB8fCB7fSkubWFwKGtleSA9PlxuICAgICAgZ2VuZXJhdGVWYWxpZGF0aW9uRXJyb3Ioa2V5LCBlcnJvcnNba2V5XSwgdGhpcy5ibHVlcHJpbnRzW2tleV0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGluc2VydEVycm9yQ2xhc3NlcygpIHtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMubWFya0VsZW1lbnQsIHRoaXMuaW52YWxpZENsYXNzZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRFcnJvcnModGhpczogVmFsaWRhdGlvbkRpcmVjdGl2ZSwgZXJyb3JzOiBWYWxpZGF0aW9uLkVycm9yW10pOiB2b2lkIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHRoaXMuZXJyb3JUZW1wbGF0ZTtcbiAgICBjb25zdCB0YXJnZXRSZWYgPSB0aGlzLmNvbnRhaW5lclJlZiA/IHRoaXMuY29udGFpbmVyUmVmLnRhcmdldFJlZiA6IHRoaXMudGFyZ2V0UmVmO1xuICAgIGNvbnN0IHZjUmVmID0gdGFyZ2V0UmVmID8gdGFyZ2V0UmVmLnZjUmVmIDogdGhpcy52Y1JlZjtcblxuICAgIHRoaXMuZXJyb3JSZWYgPVxuICAgICAgdGVtcGxhdGUgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZlxuICAgICAgICA/IHZjUmVmLmNyZWF0ZUVtYmVkZGVkVmlldyh0ZW1wbGF0ZSwgeyAkaW1wbGljaXQ6IGVycm9ycyB9LCB2Y1JlZi5sZW5ndGgpXG4gICAgICAgIDogdmNSZWYuY3JlYXRlQ29tcG9uZW50KFxuICAgICAgICAgICAgdGhpcy5jZlJlcy5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0ZW1wbGF0ZSksXG4gICAgICAgICAgICB2Y1JlZi5sZW5ndGgsXG4gICAgICAgICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgICAgICk7XG5cbiAgICBpZiAodGhpcy5lcnJvclJlZiBpbnN0YW5jZW9mIENvbXBvbmVudFJlZiAmJiB0aGlzLmVycm9yUmVmLmluc3RhbmNlKVxuICAgICAgKHRoaXMuZXJyb3JSZWYgYXMgQ29tcG9uZW50UmVmPGFueT4pLmluc3RhbmNlLnZhbGlkYXRpb25FcnJvcnMgPSBlcnJvcnM7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUVycm9yQ2xhc3NlcygpIHtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMubWFya0VsZW1lbnQsIHRoaXMuaW52YWxpZENsYXNzZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFcnJvcnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXJyb3JSZWYpIHtcbiAgICAgIHRoaXMuZXJyb3JSZWYuZGVzdHJveSgpO1xuICAgICAgdGhpcy5lcnJvclJlZiA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRNYXJrRWxlbWVudCgpOiB2b2lkIHtcbiAgICB0aGlzLm1hcmtFbGVtZW50ID1cbiAgICAgICh0aGlzLm1hcmtSZWZcbiAgICAgICAgPyB0aGlzLm1hcmtSZWYuZWxSZWYubmF0aXZlRWxlbWVudFxuICAgICAgICA6IHRoaXMudGFyZ2V0U2VsZWN0b3JcbiAgICAgICAgPyB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQuY2xvc2VzdCh0aGlzLnRhcmdldFNlbGVjdG9yKVxuICAgICAgICA6IG51bGwpIHx8IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkVmFsaWRhdGUoZXJyb3JzOiBWYWxpZGF0aW9uLkVycm9yW10pIHtcbiAgICByZXR1cm4gZXJyb3JzLmxlbmd0aCAmJiB0aGlzLmNvbnRyb2wuZGlydHkgJiYgKCF0aGlzLnZhbGlkYXRlT25TdWJtaXQgfHwgdGhpcy5pc1N1Ym1pdHRlZCk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZVRvVmFsaWRhdGlvbigpOiB2b2lkIHtcbiAgICBsZXQgY2FjaGVkOiBzdHJpbmc7XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgdGhpcy52YWxpZGF0aW9uJFxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKCkgPT4gIXRoaXMuc2tpcFZhbGlkYXRpb24pLFxuICAgICAgICAgIHRhcChmb3JtID0+IHtcbiAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgIHRoaXMuY29udHJvbC5jb250cm9sLm1hcmtBc0RpcnR5KCk7XG4gICAgICAgICAgICAgIHRoaXMuaXNTdWJtaXR0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLFxuICAgICAgICAgIG1hcCgoKSA9PlxuICAgICAgICAgICAgdGhpcy5tYXBFcnJvcnNGbihcbiAgICAgICAgICAgICAgdGhpcy5idWlsZEVycm9ycyh0aGlzLmNvbnRyb2wuZXJyb3JzKSxcbiAgICAgICAgICAgICAgdGhpcy5idWlsZEVycm9ycygodGhpcy5wYXJlbnRSZWYuZ3JvdXAgfHwgKHt9IGFzIEZvcm1Hcm91cCkpLmVycm9ycyksXG4gICAgICAgICAgICAgIHRoaXMuY29udHJvbCxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKSxcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKGVycm9ycyA9PiB7XG4gICAgICAgICAgaWYgKGNhY2hlZCA9PT0gSlNPTi5zdHJpbmdpZnkoZXJyb3JzKSkgcmV0dXJuO1xuXG4gICAgICAgICAgdGhpcy5yZW1vdmVFcnJvcnMoKTtcblxuICAgICAgICAgIGlmICh0aGlzLnNob3VsZFZhbGlkYXRlKGVycm9ycykpIHtcbiAgICAgICAgICAgIHRoaXMuaW5zZXJ0RXJyb3JzKGVycm9ycyk7XG4gICAgICAgICAgICBpZiAoIWNhY2hlZCkgdGhpcy5pbnNlcnRFcnJvckNsYXNzZXMoKTtcbiAgICAgICAgICAgIGNhY2hlZCA9IEpTT04uc3RyaW5naWZ5KGVycm9ycyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXJyb3JDbGFzc2VzKCk7XG4gICAgICAgICAgICBjYWNoZWQgPSAnJztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmNkUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuc2V0TWFya0VsZW1lbnQoKTtcbiAgICB0aGlzLnN1YnNjcmliZVRvVmFsaWRhdGlvbigpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==